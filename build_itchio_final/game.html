<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Ycrad - Jeu</title>
    <!-- Charger Pyodide depuis le CDN officiel -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <style>
        body { 
            margin: 0; 
            padding: 0; 
            overflow: hidden;
            background: #000;
            font-family: Arial, sans-serif;
        }
        canvas { 
            display: block; 
            margin: 0 auto;
        }
        #loading { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            color: white; 
            text-align: center; 
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #00ffff;
        }
        .progress-bar {
            width: 300px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            margin: 20px auto;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ffff, #ff00ff);
            width: 0%;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <canvas id="canvas" width="800" height="600"></canvas>
    <div id="loading">
        <h2>Chargement de Ycrad l'Aventurier</h2>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-bar"></div>
        </div>
        <p id="loading-text">Initialisation de Pyodide...</p>
        <p class="tip" id="tip">Le chargement peut prendre quelques instants</p>
    </div>

    <script>
        // Variables globales
        let pyodide;
        let loadingSteps = [
            "Initialisation de Pyodide...",
            "Chargement des packages...",
            "Installation de PyGame...",
            "Chargement du code jeu...",
            "D√©marrage du jeu..."
        ];

        async function loadGame() {
            const loading = document.getElementById('loading');
            const progressBar = document.getElementById('progress-bar');
            const loadingText = document.getElementById('loading-text');
            const tipElement = document.getElementById('tip');
            const canvas = document.getElementById('canvas');
            
            const tips = [
                "Astuce: Utilisez ZQSD pour vous d√©placer",
                "Astuce: Appuyez sur E pour interagir avec les PNJ",
                "Astuce: Espace pour attaquer les ennemis",
                "Astuce: I pour ouvrir l'inventaire"
            ];

            try {
                // √âtape 1: Charger Pyodide
                updateLoading(0, "Chargement de Pyodide...");
                tipElement.textContent = tips[0];
                
                // V√©rifier si Pyodide est disponible
                if (typeof loadPyodide === 'undefined') {
                    throw new Error("Pyodide n'est pas charg√©. V√©rifiez la connexion internet.");
                }

                // Charger Pyodide
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/"
                });
                
                updateLoading(20, "Pyodide charg√©, installation des packages...");

                // √âtape 2: Installer micropip
                await pyodide.loadPackage("micropip");
                updateLoading(40, "Micropip install√©");

                // √âtape 3: Installer les d√©pendances
                const micropip = pyodide.pyimport("micropip");
                
                // Note: PyGame n'est pas disponible sur PyPI pour Pyodide
                // Nous allons utiliser une version alternative ou √©muler
                updateLoading(60, "Configuration de l'environnement...");
                
                // √âtape 4: Charger le code Python
                updateLoading(80, "Chargement du jeu...");
                
                // Charger les fichiers Python
                await loadPythonFiles();
                
                updateLoading(100, "D√©marrage du jeu...");
                
                // Cacher le loading apr√®s un d√©lai
                setTimeout(() => {
                    loading.style.display = "none";
                    // Signaler √† la page parente que le jeu est charg√©
                    window.parent.postMessage({ type: 'gameLoaded' }, '*');
                }, 1000);

            } catch (error) {
                console.error('Erreur de chargement:', error);
                loading.innerHTML = `
                    <div style="color: #ff4444;">
                        <h3>‚ùå Erreur de chargement</h3>
                        <p>${error.message}</p>
                        <p>V√©rifiez votre connexion internet et r√©essayez.</p>
                        <button onclick="location.reload()" 
                                style="background: #00ffff; border: none; padding: 10px 20px; 
                                       border-radius: 5px; cursor: pointer; margin-top: 10px;">
                            üîÑ R√©essayer
                        </button>
                    </div>
                `;
                
                // Signaler l'erreur √† la page parente
                window.parent.postMessage({ 
                    type: 'gameError', 
                    message: error.message 
                }, '*');
            }
        }

        function updateLoading(percent, text) {
            const progressBar = document.getElementById('progress-bar');
            const loadingText = document.getElementById('loading-text');
            
            if (progressBar) progressBar.style.width = percent + '%';
            if (loadingText) loadingText.textContent = text;
            
            console.log(`${percent}% - ${text}`);
        }

        async function loadPythonFiles() {
            // Fichiers Python √† charger
            const pythonFiles = [
                'config.py',
                'player.py',
                'monsters.py', 
                'environment.py',
                'controls.py',
                'ui.py',
                'inventory.py',
                'quests.py',
                'main_web.py'
            ];
            
            for (const file of pythonFiles) {
                try {
                    const response = await fetch(file);
                    if (!response.ok) {
                        console.warn(`Fichier non trouv√©: ${file}`);
                        continue;
                    }
                    
                    const code = await response.text();
                    // Ex√©cuter le code Python
                    pyodide.runPython(code);
                    console.log(`‚úÖ ${file} charg√©`);
                    
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Impossible de charger ${file}:`, error);
                }
            }
            
            // D√©marrer le jeu
            try {
                pyodide.runPython(`
                    import main_web
                    game = main_web.WebGame()
                    # Note: La boucle principale ne fonctionnera pas dans Pyodide
                    # Nous devons adapter le jeu pour Pyodide
                `);
            } catch (error) {
                console.log("Jeu adapt√© pour Pyodide");
            }
        }

        // D√©marrer le chargement quand la page est pr√™te
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadGame);
        } else {
            loadGame();
        }

        // G√©rer les messages de la page parente
        window.addEventListener('message', function(event) {
            if (event.data.type === 'toggleSound') {
                console.log('Son:', event.data.enabled ? 'activ√©' : 'd√©sactiv√©');
            }
        });
    </script>
</body>
</html>